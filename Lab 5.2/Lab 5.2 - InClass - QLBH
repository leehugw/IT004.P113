--Nguyễn Lê Hưng
--23520567
--IT004.P113.2

--Lab 5.2 - InClass - QLBH﻿

-- 11. Ngày mua hàng (NGHD) của một khách hàng thành viên sẽ lớn hơn hoặc bằng ngày khách hàng đó đăng ký thành viên (NGDK). 
CREATE TRIGGER TRG_HD_KH ON HOADON
FOR INSERT, UPDATE
AS 
BEGIN 
	DECLARE @MAKH char(4), @NGDK smalldatetime, @NGHD smalldatetime
	SELECT @MAKH = MAKH, @NGHD = NGHD FROM INSERTED
	SELECT @NGDK = NGDK FROM KHACHHANG
	WHERE MAKH = @MAKH
	IF (@NGHD < @NGDK)
		BEGIN 
			PRINT 'LOI: NGAY HOA DON KHONG HOP LE'
			ROLLBACK TRANSACTION
		END
	ELSE
		BEGIN
			PRINT 'THEM THANH CONG'
		END
END

-- 12. Ngày bán hàng (NGHD) của một nhân viên phải lớn hơn hoặc bằng ngày nhân viên đó vào làm. 
CREATE TRIGGER TRG_HD_NV ON HOADON 
FOR INSERT, UPDATE
AS
BEGIN 
	DECLARE @MANV char(4), @NGHD smalldatetime, @NGVL smalldatetime
	SELECT @MANV = MANV, @NGHD = NGHD FROM INSERTED
	SELECT @NGVL = NGVL FROM NHANVIEN
	WHERE MANV = @MANV
	IF (@NGHD < @NGVL)
		BEGIN 
			PRINT 'LOI: NGAY HOA DON KHONG HOP LE'
			ROLLBACK TRANSACTION
		END 
	ELSE 
		BEGIN
			PRINT 'THEM THANH CONG'
		END
END

-- 13. Trị giá của một hóa đơn là tổng thành tiền (số lượng*đơn giá) của các chi tiết thuộc hóa đơn đó. 
CREATE TRIGGER TRG_INS_CTHD ON CTHD
FOR INSERT, UPDATE, DELETE
AS 
	BEGIN 
	DECLARE @TRIGIA money, @MASP char(4), @SOHD int, @SL int
	SELECT @SOHD = SOHD, @MASP = MASP, @SL = SL FROM INSERTED
	SET @TRIGIA = @SL * (SELECT GIA FROM SANPHAM WHERE MASP = @MASP)
	DECLARE CUR_CTHD CURSOR
	FOR 
		SELECT MASP, SL
		FROM CTHD
		WHERE SOHD = @SOHD
	OPEN CUR_CTHD
	FETCH NEXT FROM CUR_CTHD
	INTO @MASP, @SL
	WHILE (@@FETCH_STATUS = 0)
		BEGIN
			SET @TRIGIA = @TRIGIA + @SL * (SELECT GIA FROM SANPHAM WHERE MASP = @MASP)
			FETCH NEXT FROM CUR_CTHD
			INTO @MASP, @SL
		END
	CLOSE CUR_CTHD
	DEALLOCATE CUR_CTHD
	UPDATE HOADON SET TRIGIA = @TRIGIA WHERE SOHD = @SOHD
END

-- 14. Doanh số của một khách hàng là tổng trị giá các hóa đơn mà khách hàng thành viên đó đã mua. 
CREATE TRIGGER TRG_KH_HD_DS ON HOADON
FOR INSERT, UPDATE, DELETE
AS 
BEGIN
	DECLARE @SOHD int, @MAKH char(4), @TRIGIA money, @DOANHSO money
	SELECT @SOHD = SOHD, @MAKH = MAKH, @TRIGIA = TRIGIA FROM INSERTED
	SET @DOANHSO = @TRIGIA
	DECLARE CUR_HD CURSOR
	FOR 
	SELECT TRIGIA
	FROM HOADON
	WHERE MAKH = @MAKH
	OPEN CUR_HD
	FETCH NEXT FROM CUR_HD
	INTO @TRIGIA
	WHILE (@@FETCH_STATUS = 0)
		BEGIN
			SET @DOANHSO = @DOANHSO + @TRIGIA
			FETCH NEXT FROM CUR_HD
			INTO @TRIGIA
		END 
	CLOSE CUR_HD
	DEALLOCATE CUR_HD
	UPDATE KHACHHANG SET DOANHSO = @DOANHSO WHERE MAKH = @MAKH
END
